<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Agent Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {},
        },
      };
    </script>
    <script src="https://unpkg.com/alpinejs" defer></script>
    <script
      src="https://cdn.socket.io/4.8.1/socket.io.min.js"
      integrity="sha384-mkQ3/7FUtcGyoppY6bz/PORYoGqOl7/aSUMn2ymDOJcapfS6PHqxhRTMh1RR0Q6+"
      crossorigin="anonymous"
    ></script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      [x-cloak] {
        display: none !important;
      }

      body {
        font-family: "JetBrains Mono", monospace;
      }

      .terminal-text {
        font-family: "JetBrains Mono", monospace;
        font-size: 0.75rem;
        line-height: 1.4;
      }

      .scrollbar-thin::-webkit-scrollbar {
        width: 4px;
        height: 4px;
      }

      .scrollbar-thin::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.1);
      }

      .scrollbar-thin::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.3);
        border-radius: 2px;
      }

      .dark .scrollbar-thin::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
      }

      .dark .scrollbar-thin::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
      }

      .editor-line {
        counter-increment: line;
      }

      .editor-line::before {
        content: counter(line);
        display: inline-block;
        width: 3em;
        text-align: right;
        margin-right: 1em;
        color: #71717a;
        user-select: none;
      }

      .file-tree-item:hover {
        background: rgba(255, 255, 255, 0.05);
      }
    </style>
  </head>
  <body x-data="agentManager" x-init="init()" class="h-screen overflow-hidden">
    <div
      class="h-full bg-zinc-50 dark:bg-zinc-950 text-zinc-900 dark:text-zinc-100 flex flex-col"
    >
      <!-- Header -->
      <header
        class="bg-white dark:bg-zinc-900 border-b border-zinc-200 dark:border-zinc-800 px-3 py-1.5 flex items-center justify-between"
      >
        <div class="flex items-center space-x-3">
          <h1 class="font-semibold font-sans text-xs">AI Agent Manager</h1>
          <nav class="flex gap-1 items-center justify-center mx-auto">
            <button
              @click="currentView = 'sessions'"
              :class="currentView === 'sessions' ? 'bg-zinc-200 dark:bg-zinc-800 text-zinc-900 dark:text-blue-300' : 'hover:bg-zinc-100 dark:hover:bg-zinc-800'"
              class="px-2 py-0.5 rounded text-xs font-medium transition-colors"
            >
              Sessions
            </button>
            <button
              @click="currentView = 'archived'"
              :class="currentView === 'archived' ? 'bg-zinc-200 dark:bg-zinc-800 text-zinc-900 dark:text-blue-300' : 'hover:bg-zinc-100 dark:hover:bg-zinc-800'"
              class="px-2 py-0.5 rounded text-xs font-medium transition-colors"
            >
              Archived
              <span
                x-show="sessions.filter(s => s.archived).length > 0"
                class="ml-1 text-xs bg-zinc-300 dark:bg-zinc-700 px-1 rounded"
                x-text="sessions.filter(s => s.archived).length"
              ></span>
            </button>
          </nav>
        </div>
        <div class="flex items-center space-x-3">
          <div
            x-show="connectionStatus !== 'connected'"
            class="flex items-center space-x-1"
          >
            <div
              :class="{
              'bg-yellow-500': connectionStatus === 'connecting',
              'bg-red-500': connectionStatus === 'disconnected'
            }"
              class="size-2 rounded-full animate-pulse"
            ></div>
            <span
              class="text-xs text-zinc-600 dark:text-zinc-400"
              x-text="connectionStatus"
            ></span>
          </div>
          <button
            @click="toggleDarkMode()"
            class="p-1.5 rounded hover:bg-zinc-100 dark:hover:bg-zinc-800"
          >
            <svg
              x-show="!darkMode"
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
              ></path>
            </svg>
            <svg
              x-show="darkMode"
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707"
              ></path>
            </svg>
          </button>
        </div>
      </header>

      <!-- Main Content -->
      <div class="flex-1 flex overflow-hidden">
        <!-- Sessions View -->
        <template x-if="currentView === 'sessions'">
          <div class="flex flex-1">
            <!-- Left Sidebar -->
            <aside
              class="w-80 bg-zinc-100 dark:bg-zinc-900 border-r border-zinc-200 dark:border-zinc-800 flex flex-col"
            >
              <!-- New Session Input -->
              <div class="p-3 border-b border-zinc-200 dark:border-zinc-800">
                <form @submit.prevent="createSession()">
                  <textarea
                    @keydown.ctrl.n.prevent="$el.focus()"
                    x-model="newSessionTask"
                    placeholder="Task instructions (Ctrl+N)"
                    class="w-full px-2 py-1.5 text-xs bg-white dark:bg-zinc-800 border border-zinc-300 dark:border-zinc-700 rounded focus:ring-1 focus:ring-blue-500 focus:border-transparent resize-none"
                    rows="5"
                  ></textarea>
                  <button
                    type="submit"
                    :disabled="!newSessionTask.trim() || creatingSession"
                    class="w-full mt-2 px-2 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    <span x-show="!creatingSession">Create Session</span>
                    <span x-show="creatingSession">Creating...</span>
                  </button>
                </form>
              </div>

              <!-- Sessions List -->
              <div class="flex-1 overflow-y-auto scrollbar-thin">
                <div
                  x-show="sessions.length === 0"
                  class="p-4 text-center text-xs text-zinc-500"
                >
                  No sessions yet. Create one to get started!
                </div>
                <template
                  x-for="session in sessions.filter(s => !s.archived)"
                  :key="session.id"
                >
                  <div
                    :class="{
                      'bg-white dark:bg-zinc-800 shadow-sm': selectedSession?.id === session.id,
                      'ring-2 ring-orange-500': session.needsIntervention
                    }"
                    class="group p-3 border-b border-zinc-200 dark:border-zinc-800 hover:bg-zinc-50 dark:hover:bg-zinc-800/50 transition-colors"
                  >
                    <div class="flex items-start justify-between mb-1.5">
                      <div
                        class="flex-1 min-w-0 cursor-pointer"
                        @click="selectSession(session.id)"
                      >
                        <h3
                          class="font-medium text-xs truncate"
                          x-text="session.name"
                        ></h3>
                        <p
                          class="text-xs text-zinc-500 dark:text-zinc-400 truncate"
                          x-text="`ID: ${session.id.substring(0, 8)}`"
                        ></p>
                      </div>
                      <div class="flex items-center space-x-1">
                        <span
                          :class="{
                            'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400': session.status === 'active',
                            'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400': session.status === 'paused',
                            'bg-zinc-100 text-zinc-800 dark:bg-zinc-800 dark:text-zinc-400': session.status === 'completed',
                            'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400': session.status === 'error'
                          }"
                          class="text-xs px-1.5 py-0.5 rounded-full"
                          x-text="session.status"
                        ></span>
                        <!-- Action buttons -->
                        <div
                          class="opacity-0 group-hover:opacity-100 transition-opacity flex items-center space-x-0.5"
                        >
                          <button
                            @click.stop="archiveSession(session.id)"
                            title="Archive session"
                            class="p-1 hover:bg-zinc-200 dark:hover:bg-zinc-700 rounded transition-colors"
                          >
                            <svg
                              class="w-3 h-3 text-zinc-600 dark:text-zinc-400"
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"
                              ></path>
                            </svg>
                          </button>
                          <button
                            @click.stop="deleteSession(session.id)"
                            title="Delete session"
                            class="p-1 hover:bg-red-100 dark:hover:bg-red-900/30 rounded transition-colors"
                          >
                            <svg
                              class="w-3 h-3 text-red-600 dark:text-red-400"
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                              ></path>
                            </svg>
                          </button>
                        </div>
                      </div>
                    </div>

                    <!-- Mini Terminal Preview -->
                    <div
                      @click="selectSession(session.id)"
                      :class="{
                        'bg-zinc-950 text-emerald-400': session.status !== 'error',
                        'bg-red-950/30 text-red-400': session.status === 'error'
                      }"
                      class="p-1.5 rounded text-xs terminal-text h-16 overflow-hidden cursor-pointer"
                    >
                      <template x-for="lineData in $data.getIndexedArray(session.preview)" :key="`${session.id}-preview-${lineData.index}`">
                        <div x-text="lineData.item" class="truncate opacity-80"></div>
                      </template>
                    </div>

                    <!-- Progress Bar -->
                    <div class="mt-1.5" @click="selectSession(session.id)">
                      <div
                        class="flex justify-between text-xs text-zinc-600 dark:text-zinc-500 mb-0.5"
                      >
                        <span>Progress</span>
                        <span
                          x-text="`${Math.round(session.progress || 0)}%`"
                        ></span>
                      </div>
                      <div
                        class="w-full bg-zinc-200 dark:bg-zinc-800 rounded-full h-1"
                      >
                        <div
                          class="bg-blue-600 h-1 rounded-full transition-all duration-300"
                          :style="`width: ${session.progress || 0}%`"
                        ></div>
                      </div>
                    </div>
                  </div>
                </template>
              </div>
            </aside>

            <!-- Main Terminal Area -->
            <main
              class="flex-1 flex flex-col bg-white dark:bg-zinc-950 overflow-hidden"
            >
              <template x-if="selectedSession">
                <div class="flex-1 flex flex-col overflow-hidden">

                  <!-- Tab Content -->
                  <div class="flex-1 flex flex-col overflow-hidden">
                    <!-- Agent Tab -->
                    <div class="flex-1 flex overflow-hidden">
                      <!-- Left: Terminal -->
                      <div class="flex-1 flex flex-col overflow-hidden">
                        <!-- Terminal Output -->
                        <div
                          class="flex-1 bg-zinc-950 text-zinc-100 p-3 terminal-text overflow-y-auto scrollbar-thin min-h-0"
                        >
                          <template
                            x-if="selectedSession && selectedSession.messages && selectedSession.messages.length > 0"
                          >
                            <div>
                              <template
                                x-for="msgData in $data.getIndexedArray(selectedSession?.messages)"
                                :key="`${selectedSession.id}-msg-${msgData.index}-${msgData.item.id || msgData.index}`"
                              >
                                <div
                                  :class="{
                                    'text-emerald-400': msgData.item.type === 'success',
                                    'text-red-400': msgData.item.type === 'error',
                                    'text-amber-400': msgData.item.type === 'warning',
                                    'text-zinc-500': msgData.item.type === 'info',
                                    'text-blue-400': msgData.item.type === 'assistant',
                                    'text-green-400': msgData.item.type === 'user'
                                  }"
                                  x-html="msgData.item.content"
                                ></div>
                              </template>
                            </div>
                          </template>
                          <div
                            x-show="selectedSession && selectedSession.status === 'active'"
                            class="animate-pulse text-zinc-600 mt-2"
                          >
                            Waiting for response...
                          </div>
                        </div>

                        <!-- Input Area -->
                        <div
                          class="border-t border-zinc-800 bg-zinc-900 p-3 flex-shrink-0"
                        >
                          <form
                            @submit.prevent="sendMessage()"
                            class="flex flex-col space-y-2"
                          >
                            <textarea
                              x-model="messageInput"
                              @keydown.enter="if(!$event.shiftKey) { $event.preventDefault(); sendMessage(); }"
                              placeholder="Type a message to Claude... (Shift+Enter for new line)"
                              rows="3"
                              class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-md text-sm text-zinc-100 placeholder-zinc-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                              :disabled="sendingMessage || (selectedSession && selectedSession.status === 'error')"
                            ></textarea>
                            <div class="flex justify-between items-center">
                              <span
                                x-show="selectedSession && selectedSession.status === 'completed'"
                                class="text-xs text-zinc-500"
                              >
                                Session completed - send a message to resume
                              </span>
                              <span
                                x-show="selectedSession && selectedSession.status === 'error'"
                                class="text-xs text-red-500"
                              >
                                Session has errors
                              </span>
                              <button
                                type="submit"
                                :disabled="!messageInput.trim() || sendingMessage || (selectedSession && selectedSession.status === 'error')"
                                class="ml-auto px-4 py-1.5 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed text-sm font-medium transition-colors"
                              >
                                <span x-show="!sendingMessage">Send</span>
                                <span x-show="sendingMessage">Sending...</span>
                              </button>
                            </div>
                          </form>
                        </div>
                      </div>

                      <!-- Right: Debug Console -->
                      <div
                        class="w-96 border-l border-zinc-800 flex flex-col bg-zinc-900 overflow-hidden"
                      >
                        <div
                          class="p-2 border-b border-zinc-800 flex items-center justify-between flex-shrink-0"
                        >
                          <h3 class="text-xs font-semibold text-zinc-400">
                            DEBUG CONSOLE
                          </h3>
                          <button
                            @click="clearDebugLogs()"
                            class="text-xs px-2 py-0.5 text-zinc-500 hover:text-zinc-300 hover:bg-zinc-800 rounded transition-colors"
                          >
                            Clear
                          </button>
                        </div>
                        <div
                          class="flex-1 p-2 overflow-y-auto scrollbar-thin font-mono text-xs min-h-0"
                        >
                          <template x-for="log in debugLogs" :key="log.id">
                            <div
                              class="mb-1 p-1 rounded"
                              :class="{
                              'bg-red-900/20 text-red-400': log.type === 'error',
                              'bg-yellow-900/20 text-yellow-400': log.type === 'warn',
                              'bg-blue-900/20 text-blue-400': log.type === 'info',
                              'bg-green-900/20 text-green-400': log.type === 'success',
                              'bg-zinc-800/50 text-zinc-400': log.type === 'log'
                            }"
                            >
                              <div class="flex items-start space-x-2">
                                <span
                                  class="text-zinc-600 flex-shrink-0"
                                  x-text="log.time"
                                ></span>
                                <span
                                  class="font-semibold"
                                  x-text="log.label"
                                ></span>
                              </div>
                              <pre
                                class="mt-0.5 text-xs whitespace-pre-wrap"
                                x-text="log.data"
                              ></pre>
                            </div>
                          </template>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </template>

              <div
                x-show="!selectedSession"
                class="flex-1 flex items-center justify-center text-zinc-500 text-xs"
              >
                Select a session or create a new one
              </div>
            </main>
          </div>
        </template>

        <!-- Archived View -->
        <template x-if="currentView === 'archived'">
          <div class="flex-1 p-4 overflow-y-auto scrollbar-thin">
            <h2 class="text-xl font-bold mb-4">Archived Sessions</h2>
            <div
              x-show="sessions.filter(s => s.archived).length === 0"
              class="text-center text-zinc-500 text-sm p-8"
            >
              No archived sessions yet.
            </div>
            <div class="grid gap-4">
              <template
                x-for="session in sessions.filter(s => s.archived)"
                :key="session.id"
              >
                <div class="bg-white dark:bg-zinc-900 rounded-lg shadow p-4">
                  <div class="flex items-start justify-between mb-2">
                    <div>
                      <h3
                        class="font-semibold text-sm"
                        x-text="session.name"
                      ></h3>
                      <p class="text-xs text-zinc-500 dark:text-zinc-400 mt-1">
                        <span>Archived from: </span>
                        <span x-text="session.branch"></span>
                      </p>
                      <p class="text-xs text-zinc-500 dark:text-zinc-400">
                        <span>Created: </span>
                        <span
                          x-text="new Date(session.createdAt).toLocaleString()"
                        ></span>
                      </p>
                    </div>
                    <div class="flex items-center space-x-2">
                      <button
                        @click="unarchiveSession(session.id)"
                        class="px-3 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors"
                      >
                        Restore
                      </button>
                      <button
                        @click="deleteSession(session.id)"
                        class="px-3 py-1 text-xs bg-red-600 text-white rounded hover:bg-red-700 transition-colors"
                      >
                        Delete
                      </button>
                    </div>
                  </div>
                  <div
                    class="mt-2 flex items-center space-x-4 text-xs text-zinc-600 dark:text-zinc-400"
                  >
                    <span
                      >Tokens: <span x-text="session.tokensUsed || 0"></span
                    ></span>
                    <span
                      >Cost: $<span
                        x-text="(session.cost || 0).toFixed(4)"
                      ></span
                    ></span>
                    <span
                      >Messages:
                      <span x-text="session.messages?.length || 0"></span
                    ></span>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </template>


      </div>

      <!-- Keyboard Shortcuts Modal -->
      <div
        x-show="showShortcuts"
        x-cloak
        @keydown.escape="showShortcuts = false"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
      >
        <div
          class="bg-white dark:bg-zinc-900 rounded-lg shadow-xl max-w-md w-full p-5"
        >
          <h3 class="text-sm font-semibold mb-3">Keyboard Shortcuts</h3>
          <div class="space-y-1.5 text-xs">
            <div class="flex justify-between">
              <span class="text-zinc-600 dark:text-zinc-400">New Session</span>
              <kbd
                class="px-1.5 py-0.5 bg-zinc-100 dark:bg-zinc-800 rounded text-xs"
                >Ctrl + N</kbd
              >
            </div>
            <div class="flex justify-between">
              <span class="text-zinc-600 dark:text-zinc-400">Switch Tabs</span>
              <kbd
                class="px-1.5 py-0.5 bg-zinc-100 dark:bg-zinc-800 rounded text-xs"
                >Tab</kbd
              >
            </div>
            <div class="flex justify-between">
              <span class="text-zinc-600 dark:text-zinc-400"
                >Navigate Sessions</span
              >
              <kbd
                class="px-1.5 py-0.5 bg-zinc-100 dark:bg-zinc-800 rounded text-xs"
                >↑ ↓</kbd
              >
            </div>
            <div class="flex justify-between">
              <span class="text-zinc-600 dark:text-zinc-400"
                >Toggle Dark Mode</span
              >
              <kbd
                class="px-1.5 py-0.5 bg-zinc-100 dark:bg-zinc-800 rounded text-xs"
                >Ctrl + D</kbd
              >
            </div>
            <div class="flex justify-between">
              <span class="text-zinc-600 dark:text-zinc-400"
                >Show Shortcuts</span
              >
              <kbd
                class="px-1.5 py-0.5 bg-zinc-100 dark:bg-zinc-800 rounded text-xs"
                >?</kbd
              >
            </div>
          </div>
          <button
            @click="showShortcuts = false"
            class="mt-4 w-full px-3 py-1.5 bg-blue-500 text-white rounded text-xs hover:bg-blue-600 transition-colors"
          >
            Close
          </button>
        </div>
      </div>

    </div>

    <script>
      // AI Agent Manager - Refactored Alpine.js Application
      document.addEventListener("alpine:init", () => {
        Alpine.data("agentManager", () => ({
          // ===== CONSTANTS =====
          MAX_ACTIVITY_ITEMS: 50,
          MAX_DEBUG_LOGS: 100,
          SESSION_DELAY_MS: 100,
          SEND_MESSAGE_DELAY_MS: 1000,
          
          // ===== STATE MANAGEMENT =====
          // UI State
          ui: {
            darkMode: true,
            currentView: "sessions",
            activeTab: "agent",
            showShortcuts: false,
            connectionStatus: "disconnected",
          },
          
          // Session Management
          sessionState: {
            selectedSession: null,
            sessions: [],
            creatingSession: false,
            newSessionTask: "",
            pendingMessages: [],
          },
          
          // Messaging
          messaging: {
            messageInput: "",
            sendingMessage: false,
          },
          
          // File Management
          fileState: {
            selectedFile: null,
            expandedFolders: new Set(),
          },
          
          // Activity & Debug
          logs: {
            recentActivity: [],
            debugLogs: [],
          },
          
          // Socket
          socket: null,
          
          // ===== COMPUTED PROPERTIES =====
          get darkMode() {
            return this.ui.darkMode;
          },
          
          set darkMode(value) {
            this.ui.darkMode = value;
          },
          
          get currentView() {
            return this.ui.currentView;
          },
          
          set currentView(value) {
            this.ui.currentView = value;
          },
          
          get activeTab() {
            return this.ui.activeTab;
          },
          
          set activeTab(value) {
            this.ui.activeTab = value;
          },
          
          get showShortcuts() {
            return this.ui.showShortcuts;
          },
          
          set showShortcuts(value) {
            this.ui.showShortcuts = value;
          },
          
          get connectionStatus() {
            return this.ui.connectionStatus;
          },
          
          set connectionStatus(value) {
            this.ui.connectionStatus = value;
          },
          
          get selectedSession() {
            return this.sessionState.selectedSession;
          },
          
          set selectedSession(value) {
            this.sessionState.selectedSession = value;
          },
          
          get sessions() {
            return this.sessionState.sessions;
          },
          
          set sessions(value) {
            this.sessionState.sessions = value;
          },
          
          get creatingSession() {
            return this.sessionState.creatingSession;
          },
          
          set creatingSession(value) {
            this.sessionState.creatingSession = value;
          },
          
          get newSessionTask() {
            return this.sessionState.newSessionTask;
          },
          
          set newSessionTask(value) {
            this.sessionState.newSessionTask = value;
          },
          
          get pendingMessages() {
            return this.sessionState.pendingMessages;
          },
          
          set pendingMessages(value) {
            this.sessionState.pendingMessages = value;
          },
          
          get messageInput() {
            return this.messaging.messageInput;
          },
          
          set messageInput(value) {
            this.messaging.messageInput = value;
          },
          
          get sendingMessage() {
            return this.messaging.sendingMessage;
          },
          
          set sendingMessage(value) {
            this.messaging.sendingMessage = value;
          },
          
          get selectedFile() {
            return this.fileState.selectedFile;
          },
          
          set selectedFile(value) {
            this.fileState.selectedFile = value;
          },
          
          get expandedFolders() {
            return this.fileState.expandedFolders;
          },
          
          get recentActivity() {
            return this.logs.recentActivity;
          },
          
          set recentActivity(value) {
            this.logs.recentActivity = value;
          },
          
          get debugLogs() {
            return this.logs.debugLogs;
          },
          
          set debugLogs(value) {
            this.logs.debugLogs = value;
          },
          
          // ===== INITIALIZATION =====
          init() {
            this.setupErrorHandling();
            this.loadUserPreferences();
            this.setupKeyboardShortcuts();
            this.connectToBackend();
          },
          
          setupErrorHandling() {
            window.addEventListener("error", (e) => {
              console.error("Global error:", e);
              this.debugLog("Global Error", {
                message: e.message,
                filename: e.filename,
                line: e.lineno,
                col: e.colno,
                error: e.error?.stack,
              }, "error");
            });
          },
          
          loadUserPreferences() {
            const savedDarkMode = localStorage.getItem("darkMode");
            this.darkMode = savedDarkMode === null ? true : savedDarkMode === "true";
            this.applyDarkMode();
          },
          
          applyDarkMode() {
            if (this.darkMode) {
              document.documentElement.classList.add("dark");
            } else {
              document.documentElement.classList.remove("dark");
            }
          },
          
          setupKeyboardShortcuts() {
            document.addEventListener("keydown", (e) => {
              if (e.ctrlKey) {
                switch(e.key) {
                  case "n":
                    e.preventDefault();
                    const taskInput = document.querySelector('[x-model="newSessionTask"]');
                    if (taskInput) taskInput.focus();
                    break;
                  case "d":
                    e.preventDefault();
                    this.toggleDarkMode();
                    break;
                }
              } else if (e.key === "?") {
                this.showShortcuts = true;
              }
            });
          },
          
          // ===== SOCKET CONNECTION =====
          connectToBackend() {
            this.connectionStatus = "connecting";
            const currentUrl = window.location.origin;
            
            this.socket = io(currentUrl, {
              transports: ["websocket", "polling"],
            });
            
            this.setupSocketHandlers();
          },
          
          setupSocketHandlers() {
            // Connection events
            this.socket.on("connect", () => this.handleConnect());
            this.socket.on("disconnect", () => this.handleDisconnect());
            this.socket.on("error", (error) => this.handleSocketError(error));
            
            // Session events
            this.socket.on("sessions:list", (sessions) => this.handleSessionsList(sessions));
            this.socket.on("session:created", (session) => this.handleSessionCreated(session));
            this.socket.on("session:status", (data) => this.handleSessionStatus(data));
            this.socket.on("session:complete", (data) => this.handleSessionComplete(data));
            this.socket.on("session:intervention", (data) => this.handleSessionIntervention(data));
            this.socket.on("session:error", (data) => this.handleSessionError(data));
            
            // Message events
            this.socket.on("claude:message", (data) => this.handleClaudeMessage(data));
            
            // File events
            this.socket.on("files:list", (data) => this.handleFilesList(data));
            this.socket.on("file:content", (data) => this.handleFileContent(data));
            this.socket.on("file:saved", (data) => this.handleFileSaved(data));
            
            // Git events
            this.socket.on("git:log", (data) => this.handleGitLog(data));
          },
          
          // ===== CONNECTION HANDLERS =====
          handleConnect() {
            console.log("Connected to backend");
            this.connectionStatus = "connected";
            this.addActivity("Connected to backend");
          },
          
          handleDisconnect() {
            console.log("Disconnected from backend");
            this.connectionStatus = "disconnected";
            this.addActivity("Disconnected from backend");
          },
          
          handleSocketError(error) {
            console.error("Socket error:", error);
            this.debugLog("Socket Error", error, "error");
            this.addActivity(`Error: ${error.message || "An unexpected error occurred"}`);
            
            if (error.message?.includes("Failed to create session")) {
              this.creatingSession = false;
            }
          },
          
          // ===== SESSION EVENT HANDLERS =====
          handleSessionsList(sessions) {
            console.log("Received initial sessions list:", sessions);
            this.debugLog("sessions:list", sessions, "info");
            
            if (this.sessions.length === 0) {
              this.sessions = sessions.map((s) => this.normalizeSession(s));
              
              this.debugLog("Sessions initialized", {
                count: this.sessions.length
              }, "success");
              
              if (this.sessions.length > 0 && !this.selectedSession) {
                this.selectSession(this.sessions[0].id);
              }
            }
          },
          
          handleSessionCreated(session) {
            console.log("Session created event received:", session);
            this.debugLog("session:created", session, "info");
            
            if (this.sessions.find((s) => s.id === session.id)) {
              console.log("Session already exists, skipping:", session.id);
              this.debugLog("Session already exists", {
                sessionId: session.id
              }, "warn");
              return;
            }
            
            const newSession = this.normalizeSession(session);
            
            this.debugLog("Creating new session", {
              id: newSession.id,
              hasMessages: !!session.messages,
              messagesLength: session.messages?.length || 0,
            }, "info");
            
            console.log("Adding session to list:", newSession);
            this.sessions.unshift(newSession);
            console.log("Sessions after adding:", this.sessions);
            
            setTimeout(() => {
              this.selectSession(session.id);
            }, this.SESSION_DELAY_MS);
            
            this.addActivity(`Created session: ${session.name}`);
            this.creatingSession = false;
            
            this.processPendingMessages(session.id);
          },
          
          handleSessionStatus(data) {
            const session = this.sessions.find((s) => s.id === data.sessionId);
            if (session) {
              session.status = data.status;
              this.addActivity(`Session ${session.name} is now ${data.status}`);
            }
          },
          
          handleSessionComplete(data) {
            const session = this.sessions.find((s) => s.id === data.sessionId);
            if (session) {
              session.progress = 100;
              session.status = "completed";
              this.addActivity(`Session ${session.name} completed`);
            }
          },
          
          handleSessionIntervention(data) {
            const session = this.sessions.find((s) => s.id === data.sessionId);
            if (session) {
              session.needsIntervention = true;
              this.addActivity(`Session ${session.name} needs intervention: ${data.reason}`);
            }
          },
          
          handleSessionError(data) {
            const session = this.sessions.find((s) => s.id === data.sessionId);
            if (session) {
              session.status = "error";
              session.messages.push({
                id: Date.now(),
                type: "error",
                content: `Error: ${data.error}`,
              });
              this.addActivity(`Session ${session.name} encountered an error`);
            }
          },
          
          // ===== MESSAGE HANDLERS =====
          handleClaudeMessage(data) {
            console.log("Claude message received:", data);
            
            const session = this.sessions.find((s) => s.id === data.sessionId);
            if (!session) {
              console.warn("Session not found for Claude message, queueing:", data.sessionId);
              this.pendingMessages.push(data);
              return;
            }
            
            this.processClaudeMessage(session, data);
          },
          
          processClaudeMessage(session, data) {
            this.debugLog("handleClaudeMessage", {
              sessionId: data.sessionId,
              messageType: data.message?.type
            }, "info");
            
            const message = data.message;
            
            if (!session.messages) {
              session.messages = [];
              this.debugLog("Initialized messages for session", {
                sessionId: data.sessionId
              }, "warn");
            }
            
            if (message.type === "assistant") {
              const content = message.message?.content || "";
              if (content) {
                const terminalMessage = {
                  id: Date.now(),
                  type: "assistant",
                  content: this.escapeHtml(content).substring(0, 500) + 
                          (content.length > 500 ? "..." : ""),
                };
                session.messages.push(terminalMessage);
                this.debugLog("Added assistant message", {
                  sessionId: data.sessionId,
                  contentLength: content.length,
                  messagesLength: session.messages.length,
                }, "success");
              }
            } else if (message.type === "result") {
              const content = message.result || "Task completed";
              const terminalMessage = {
                id: Date.now(),
                type: "assistant",
                content: this.escapeHtml(content),
              };
              session.messages.push(terminalMessage);
              session.preview = ["✓ " + content.substring(0, 50) + "..."];
              this.debugLog("Added result message", {
                sessionId: data.sessionId,
                result: content
              }, "success");
            } else if (message.type === "user") {
              const content = message.message?.content || "";
              if (content) {
                const terminalMessage = {
                  id: Date.now(),
                  type: "user",
                  content: this.escapeHtml(content),
                };
                session.messages.push(terminalMessage);
                this.debugLog("Added user message", {
                  sessionId: data.sessionId,
                  content
                }, "success");
              }
            }
            
            if (message.type !== "result") {
              session.preview = session.messages
                .slice(-3)
                .map((o) => o.content.substring(0, 60) + "...");
            }
          },
          
          processPendingMessages(sessionId) {
            const messages = this.pendingMessages.filter((m) => m.sessionId === sessionId);
            messages.forEach((data) => {
              console.log("Processing pending message for session:", sessionId);
              this.handleClaudeMessage(data);
            });
            this.pendingMessages = this.pendingMessages.filter((m) => m.sessionId !== sessionId);
          },
          
          // ===== FILE EVENT HANDLERS =====
          handleFilesList(data) {
            const session = this.sessions.find((s) => s.id === data.sessionId);
            if (session) {
              session.files = data.files;
            }
          },
          
          handleFileContent(data) {
            if (this.selectedFile && this.selectedFile.path === data.path) {
              this.selectedFile.content = data.content;
              this.selectedFile.modified = false;
            }
          },
          
          handleFileSaved(data) {
            if (this.selectedFile && this.selectedFile.path === data.path) {
              this.selectedFile.modified = false;
              this.addActivity(`Saved ${data.path}`);
            }
          },
          
          // ===== GIT EVENT HANDLERS =====
          handleGitLog(data) {
            const session = this.sessions.find((s) => s.id === data.sessionId);
            if (session) {
              session.commits = data.commits;
            }
          },
          
          // ===== UI ACTIONS =====
          toggleDarkMode() {
            this.darkMode = !this.darkMode;
            localStorage.setItem("darkMode", this.darkMode);
            this.applyDarkMode();
          },
          
          // ===== SESSION MANAGEMENT =====
          createSession() {
            if (!this.newSessionTask.trim()) return;
            
            this.creatingSession = true;
            this.socket.emit("session:create", {
              name: undefined,
              task: this.newSessionTask,
            });
            
            this.newSessionTask = "";
          },
          
          selectSession(id) {
            const session = this.sessions.find((s) => s.id === id);
            if (!session) {
              this.debugLog("selectSession", {
                sessionId: id,
                error: "Session not found",
              }, "error");
              return;
            }
            
            if (!session.messages) {
              session.messages = [];
            }
            
            this.selectedSession = session;
            this.selectedFile = null;
            
            this.debugLog("selectSession", {
              sessionId: id,
              found: !!this.selectedSession,
              messagesLength: this.selectedSession?.messages?.length || 0,
            }, "info");
            
            this.socket.emit("files:list", id);
            this.socket.emit("git:log", id);
          },
          
          pauseSession() {
            if (this.selectedSession && this.selectedSession.status === "active") {
              this.socket.emit("session:pause", this.selectedSession.id);
            }
          },
          
          resumeSession() {
            if (this.selectedSession && this.selectedSession.status === "paused") {
              this.socket.emit("session:resume", {
                sessionId: this.selectedSession.id,
              });
            }
          },
          
          stopSession() {
            if (this.selectedSession && this.selectedSession.status !== "completed") {
              if (confirm("Are you sure you want to stop this session?")) {
                this.socket.emit("session:stop", this.selectedSession.id);
              }
            }
          },
          
          sendMessage() {
            if (!this.messageInput.trim() || !this.selectedSession || this.sendingMessage) {
              return;
            }
            
            const message = this.messageInput.trim();
            this.sendingMessage = true;
            
            this.selectedSession.messages.push({
              id: Date.now(),
              type: "user",
              content: this.escapeHtml(message),
            });
            
            this.messageInput = "";
            this.selectedSession.status = "active";
            
            this.socket.emit("session:resume", {
              sessionId: this.selectedSession.id,
              prompt: message,
            });
            
            setTimeout(() => {
              this.sendingMessage = false;
            }, this.SEND_MESSAGE_DELAY_MS);
          },
          
          archiveSession(sessionId) {
            const session = this.sessions.find((s) => s.id === sessionId);
            if (!session) return;
            
            if (confirm(`Archive session "${session.name}"?`)) {
              session.archived = true;
              
              if (this.selectedSession?.id === sessionId) {
                this.selectedSession = null;
              }
              
              this.socket.emit("session:archive", sessionId);
              this.addActivity(`Archived session: ${session.name}`);
            }
          },
          
          deleteSession(sessionId) {
            const session = this.sessions.find((s) => s.id === sessionId);
            if (!session) return;
            
            if (confirm(`Permanently delete session "${session.name}"? This cannot be undone.`)) {
              if (this.selectedSession?.id === sessionId) {
                this.selectedSession = null;
              }
              
              this.sessions = this.sessions.filter((s) => s.id !== sessionId);
              
              this.socket.emit("session:delete", sessionId);
              this.addActivity(`Deleted session: ${session.name}`);
            }
          },
          
          unarchiveSession(sessionId) {
            const session = this.sessions.find((s) => s.id === sessionId);
            if (!session) return;
            
            session.archived = false;
            
            this.socket.emit("session:unarchive", sessionId);
            this.addActivity(`Restored session: ${session.name}`);
          },
          
          // ===== FILE MANAGEMENT =====
          toggleFolder(path) {
            if (this.expandedFolders.has(path)) {
              this.expandedFolders.delete(path);
            } else {
              this.expandedFolders.add(path);
            }
          },
          
          isFolderExpanded(path) {
            return this.expandedFolders.has(path);
          },
          
          openFile(path) {
            const findFile = (files, targetPath) => {
              for (const file of files) {
                if (file.path === targetPath) return file;
                if (file.children) {
                  const found = findFile(file.children, targetPath);
                  if (found) return found;
                }
              }
              return null;
            };
            
            const file = findFile(this.selectedSession.files, path);
            if (file && file.type === "file") {
              this.selectedFile = { ...file, modified: false };
              
              if (!this.selectedFile.content) {
                this.socket.emit("file:read", {
                  sessionId: this.selectedSession.id,
                  path: path,
                });
              }
            }
          },
          
          refreshFiles() {
            if (this.selectedSession) {
              this.socket.emit("files:list", this.selectedSession.id);
            }
          },
          
          reloadFile() {
            if (this.selectedFile && this.selectedSession) {
              this.socket.emit("file:read", {
                sessionId: this.selectedSession.id,
                path: this.selectedFile.path,
              });
            }
          },
          
          saveFile() {
            if (this.selectedFile && this.selectedSession && this.selectedFile.modified) {
              this.socket.emit("file:save", {
                sessionId: this.selectedSession.id,
                path: this.selectedFile.path,
                content: this.selectedFile.content,
              });
            }
          },
          
          refreshGitLog() {
            if (this.selectedSession) {
              this.socket.emit("git:log", this.selectedSession.id);
            }
          },
          
          renderFileTree(file) {
            if (file.type === "folder") {
              return `
                <div>
                  <div
                    @click="toggleFolder('${file.path}')"
                    class="flex items-center space-x-1 px-2 py-0.5 rounded cursor-pointer hover:bg-zinc-200 dark:hover:bg-zinc-800 file-tree-item"
                  >
                    <svg
                      :class="{'rotate-90': isFolderExpanded('${file.path}')}"
                      class="w-3 h-3 transition-transform"
                      fill="currentColor"
                      viewBox="0 0 20 20"
                    >
                      <path
                        fill-rule="evenodd"
                        d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                        clip-rule="evenodd"
                      ></path>
                    </svg>
                    <svg
                      class="w-3 h-3 text-blue-600 dark:text-blue-400"
                      fill="currentColor"
                      viewBox="0 0 20 20"
                    >
                      <path
                        d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"
                      ></path>
                    </svg>
                    <span class="text-xs">${file.name}</span>
                  </div>
                  <div x-show="isFolderExpanded('${file.path}')" class="ml-3">
                    ${file.children ? file.children.map((child) => this.renderFileTree(child)).join("") : ""}
                  </div>
                </div>
              `;
            } else {
              return `
                <div
                  @click="openFile('${file.path}')"
                  :class="{'bg-zinc-200 dark:bg-zinc-800': selectedFile?.path === '${file.path}'}"
                  class="flex items-center space-x-1 px-2 py-0.5 rounded cursor-pointer hover:bg-zinc-200 dark:hover:bg-zinc-800 file-tree-item"
                >
                  <svg
                    class="w-3 h-3 text-zinc-500"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm2 4a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z"
                      clip-rule="evenodd"
                    ></path>
                  </svg>
                  <span class="text-xs">${file.name}</span>
                </div>
              `;
            }
          },
          
          // ===== COMPUTED PROPERTIES =====
          get totalTokens() {
            return this.sessions.reduce((sum, session) => sum + (session.tokensUsed || 0), 0);
          },
          
          get totalTasks() {
            return this.sessions.reduce((sum, session) => sum + (session.todos?.length || 0), 0);
          },
          
          get tasksCompleted() {
            return this.sessions.reduce(
              (sum, session) => sum + (session.todos?.filter((t) => t.status === "done").length || 0),
              0
            );
          },
          
          get tasksInProgress() {
            return this.sessions.reduce(
              (sum, session) => sum + (session.todos?.filter((t) => t.status === "in-progress").length || 0),
              0
            );
          },
          
          get tasksTodo() {
            return this.sessions.reduce(
              (sum, session) => sum + (session.todos?.filter((t) => t.status === "todo").length || 0),
              0
            );
          },
          
          get completionRate() {
            return this.totalTasks > 0
              ? Math.round((this.tasksCompleted / this.totalTasks) * 100)
              : 0;
          },
          
          toggleTodo(todoId) {
            const todo = this.selectedSession.todos.find((t) => t.id === todoId);
            if (todo) {
              const states = ["todo", "in-progress", "done"];
              const currentIndex = states.indexOf(todo.status);
              todo.status = states[(currentIndex + 1) % states.length];
            }
          },
          
          // ===== UTILITY FUNCTIONS =====
          escapeHtml(text) {
            const div = document.createElement("div");
            div.textContent = text;
            return div.innerHTML;
          },
          
          addActivity(message) {
            this.recentActivity.unshift({
              id: Date.now(),
              time: new Date().toLocaleTimeString(),
              message,
            });
            if (this.recentActivity.length > this.MAX_ACTIVITY_ITEMS) {
              this.recentActivity = this.recentActivity.slice(0, this.MAX_ACTIVITY_ITEMS);
            }
          },
          
          debugLog(label, data, type = "log") {
            const log = {
              id: Date.now() + Math.random(),
              time: new Date().toLocaleTimeString(),
              label,
              data: typeof data === "object" ? JSON.stringify(data, null, 2) : String(data),
              type,
            };
            this.debugLogs.unshift(log);
            
            if (this.debugLogs.length > this.MAX_DEBUG_LOGS) {
              this.debugLogs = this.debugLogs.slice(0, this.MAX_DEBUG_LOGS);
            }
          },
          
          clearDebugLogs() {
            this.debugLogs = [];
          },
          
          getIndexedArray(array) {
            if (!array) return [];
            return array.map((item, index) => ({ item, index }));
          },
          
          normalizeSession(session) {
            return {
              ...session,
              preview: session.preview || ["> Waiting for output..."],
              messages: session.messages || [],
              commits: session.commits || [],
              todos: session.todos || [],
              files: session.files || [],
            };
          },
        }));
      });
    </script>
  </body>
</html>
